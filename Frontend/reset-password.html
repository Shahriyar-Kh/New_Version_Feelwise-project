<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FeelWise - Reset Password</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="login.css">
  </head>
  <body>
    <!-- Animated background bubbles -->
    <ul class="bg-bubbles">
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
    </ul>

    <!-- Reset Password Form -->
    <div class="login-container">
      <div class="logo">
        <div class="logo-circle">
          <i class="fas fa-brain"></i>
        </div>
        <div class="logo-text">
          <h1>FeelWise</h1>
          <p>Emotional Intelligence Platform</p>
        </div>
      </div>

      <h2>Reset Your Password</h2>
      <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 25px; font-size: 0.95rem;">
        Enter your new password below
      </p>

      <form id="reset-password-form">
        <div class="input-group">
          <i class="fas fa-lock input-icon"></i>
          <input
            type="password"
            id="new-password"
            placeholder="New Password"
            required
            minlength="6"
          />
        </div>

        <div class="input-group">
          <i class="fas fa-lock input-icon"></i>
          <input
            type="password"
            id="confirm-password"
            placeholder="Confirm New Password"
            required
            minlength="6"
          />
        </div>

        <p class="error-message" id="reset-error"></p>
        <p class="success-message" id="reset-success"></p>

        <button type="submit">
          Reset Password <i class="fas fa-check" style="margin-left: 8px"></i>
        </button>
      </form>

      <p style="margin-top: 20px;">
        <a href="login.html">← Back to Login</a>
      </p>

      <div class="footer">
        <p>© 2023 FeelWise. All rights reserved.</p>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api/auth";
      const resetForm = document.getElementById("reset-password-form");
      const resetError = document.getElementById("reset-error");
      const resetSuccess = document.getElementById("reset-success");

      // Get token and email from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const email = urlParams.get('email');

      // Verify token on page load
      window.addEventListener('load', async () => {
        if (!token || !email) {
          resetError.style.display = "block";
          resetError.textContent = "Invalid reset link. Please request a new password reset.";
          resetForm.querySelector('button').disabled = true;
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/verify-reset-token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, email }),
          });

          if (!res.ok) {
            const data = await res.json();
            resetError.style.display = "block";
            resetError.textContent = data.error || "This reset link has expired or is invalid. Please request a new one.";
            resetForm.querySelector('button').disabled = true;
          }
        } catch (err) {
          console.error("Token verification error:", err);
          resetError.style.display = "block";
          resetError.textContent = "Failed to verify reset link. Please try again.";
          resetForm.querySelector('button').disabled = true;
        }
      });

      resetForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        resetError.style.display = "none";
        resetSuccess.style.display = "none";

        const newPassword = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;

        // Client-side validation
        if (newPassword !== confirmPassword) {
          resetError.style.display = "block";
          resetError.textContent = "Passwords do not match";
          return;
        }

        if (newPassword.length < 6) {
          resetError.style.display = "block";
          resetError.textContent = "Password must be at least 6 characters long";
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: token,
              email: email,
              newPassword: newPassword,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            resetError.style.display = "block";
            resetError.textContent = data.error || "Failed to reset password";
            return;
          }

          resetSuccess.style.display = "block";
          resetSuccess.textContent = "Password reset successful! Redirecting to login...";

          // Disable form
          resetForm.querySelector('button').disabled = true;
          document.getElementById("new-password").disabled = true;
          document.getElementById("confirm-password").disabled = true;

          // Redirect to login after 2 seconds
          setTimeout(() => {
            window.location.href = "login.html";
          }, 2000);

        } catch (err) {
          console.error("Password reset error:", err);
          resetError.style.display = "block";
          resetError.textContent = "An error occurred. Please try again.";
        }
      });
    </script>
  </body>
</html>